<div class="square-map-container">
  <div #rendererContainer id="rendererContainer"></div>
  
  <!-- Toggle button for filters panel -->
  <button class="filters-toggle" [class.panel-visible]="filtersPanelVisible" (click)="toggleFiltersPanel()">
    {{ filtersPanelVisible ? '‚óÄ HIDE' : '‚ñ∂ SHOW' }}
  </button>
  
  <!-- Hover Tooltip -->
  <div class="hover-tooltip" *ngIf="hoveredTileInfo">
    <div class="tooltip-biome">{{ hoveredTileInfo.biome }}</div>
    <div class="tooltip-coords">Position: ({{ hoveredTileInfo.x }}, {{ hoveredTileInfo.z }})</div>
  </div>
  
  <!-- Camera Info -->
  <div class="camera-info">
    <div>Distance: {{ cameraDistance.toFixed(1) }}</div>
  </div>
  
  <div class="filters" [class.visible]="filtersPanelVisible">
    
    <!-- Terrain Generation Controls -->
    <div class="collapsible-section">
      <div class="collapsible-header" [class.collapsed]="sectionsCollapsed.terrain" (click)="toggleSection('terrain')">
        <span>üó∫Ô∏è Terrain Generation</span>
        <span class="collapsible-icon" [class.collapsed]="sectionsCollapsed.terrain">‚ñº</span>
      </div>
      <div class="collapsible-content" [class.collapsed]="sectionsCollapsed.terrain">
        <div class="section-body">
          <div style="background: #f1f8ff; padding: 12px; border-radius: 4px; border: 1px solid #b3d9ff;">
            <div style="font-weight: 600; color: #2c5aa0; margin-bottom: 8px;">üåç Earth-Based Biome Percentages</div>
            <div style="font-size: 12px; color: #666;">
              The map enforces exact Earth percentages and applies clustering to preserve natural appearance.
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Population-Based Map Sizing -->
    <div class="collapsible-section">
      <div class="collapsible-header" [class.collapsed]="sectionsCollapsed.population" (click)="toggleSection('population')">
        <span>üë• Population & Map Size</span>
        <span class="collapsible-icon" [class.collapsed]="sectionsCollapsed.population">‚ñº</span>
      </div>
      <div class="collapsible-content" [class.collapsed]="sectionsCollapsed.population">
        <div class="section-body">
          <label style="display: flex; align-items: center; margin-bottom: 15px; cursor: pointer;">
            <input type="checkbox" [(ngModel)]="usePopulationSizing" (change)="updateMap()" style="margin-right: 8px;" />
            <span style="font-weight: 600;">Use Population-Based Map Size</span>
          </label>
          <label style="display: block; margin-bottom: 15px;">
            <span style="font-weight: 600; display: block; margin-bottom: 8px;">Year:</span>
            <input type="number" min="1800" max="2050" [(ngModel)]="selectedYear" (change)="onYearChange($event)" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
          </label>
      <div class="population-info" *ngIf="usePopulationSizing">
        <small>
          <strong>Population in {{ selectedYear }}: {{ getWorldPopulation(selectedYear).toLocaleString() }}</strong><br><br>
          
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <!-- Total Earth Surface Table -->
            <div style="flex: 1; min-width: 250px;">
              <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th colspan="2" style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">üåç Total Earth Surface Per Person</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                <td style="padding: 8px 12px; border-bottom: 1px solid #eee; font-weight: 500;">Total area (inc. oceans):</td>
                <td style="padding: 8px 12px; border-bottom: 1px solid #eee;">{{ totalAreaPerPerson.toLocaleString() }} m¬≤</td>
                </tr>
                <tr>
                <td style="padding: 8px 12px; border-bottom: 1px solid #eee; font-weight: 500;">Map dimensions:</td>
                <td style="padding: 8px 12px; border-bottom: 1px solid #eee;">{{ populationBasedMapSize }} √ó {{ populationBasedMapSize }} tiles</td>
                </tr>
                <tr>
                <td style="padding: 8px 12px; border-bottom: 1px solid #eee; font-weight: 500;">Ocean area (70.9%):</td>
                <td style="padding: 8px 12px; border-bottom: 1px solid #eee;">{{ oceanAreaPerPerson.toLocaleString() }} m¬≤</td>
                </tr>
                <tr>
                <td style="padding: 8px 12px; font-weight: 500;">Total land area (29.1%):</td>
                <td style="padding: 8px 12px;">{{ squareMetersPerPerson.toLocaleString() }} m¬≤</td>
                </tr>
              </tbody>
              </table>
            </div>

            <!-- Biome Breakdown Table -->
            <div style="flex: 1; min-width: 300px;">
              <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th colspan="2" style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">üó∫Ô∏è Biome Breakdown Per Person</th>
                </tr>
              </thead>
              <tbody>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Saltwater (oceans/seas):</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['saltwater'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Freshwater (lakes/rivers):</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['freshwater'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Boreal Forest:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['borealForest'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Temperate Forest:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['temperateForest'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Tropical Rainforest:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['tropicalRainforest'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Temperate Grassland:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['temperateGrassland'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Savanna:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['savanna'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Tundra:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['tundra'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Deserts:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['deserts'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Mountains:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['mountains'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Pastureland:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['pastureland'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Cropland:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['cropland'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">Scrub:</td><td style="padding: 6px 12px; border-bottom: 1px solid #eee; font-size: 13px;">{{ landBreakdownPerPerson['scrub'].toLocaleString() }} m¬≤</td></tr>
                <tr><td style="padding: 6px 12px; font-size: 13px;">Urban Areas:</td><td style="padding: 6px 12px; font-size: 13px;">{{ landBreakdownPerPerson['urban'].toLocaleString() }} m¬≤</td></tr>
              </tbody>
              </table>
            </div>
            </div>
            
          <div style="margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 4px; border-left: 4px solid #4caf50;">
            <strong style="color: #2e7d32;">Map Visualization:</strong><br>
            <div style="font-size: 12px; color: #666; margin-top: 8px; line-height: 1.6;">
              ‚Ä¢ Each tile: 1m √ó 1m<br>
              ‚Ä¢ Map size: {{ populationBasedMapSize }}√ó{{ populationBasedMapSize }} tiles<br>
              ‚Ä¢ Represents: {{ (populationBasedMapSize * populationBasedMapSize).toLocaleString() }} m¬≤ (1:1 scale)<br>
              ‚Ä¢ Total Earth surface per person: {{ totalAreaPerPerson.toLocaleString() }} m¬≤<br>
              ‚Ä¢ <strong>TRUE 1:1 SCALE</strong> - Each square meter = 1 real m¬≤ of your Earth share!
            </div>
          </div>
        </small>
      </div>
        </div>
      </div>
    </div>
    
    <!-- Map Legend -->
    <div class="collapsible-section">
      <div class="collapsible-header" [class.collapsed]="sectionsCollapsed.legend" (click)="toggleSection('legend')">
        <span>üó∫Ô∏è Biome Legend & Stats</span>
        <span class="collapsible-icon" [class.collapsed]="sectionsCollapsed.legend">‚ñº</span>
      </div>
      <div class="collapsible-content" [class.collapsed]="sectionsCollapsed.legend">
        <div class="section-body">
      <!-- Water Biomes -->
      <div style="margin-bottom: 15px;">
        <h5 style="margin-bottom: 10px; color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 5px;">üíß Water Bodies</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #20a0ff; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Saltwater (Oceans/Seas)</strong><br>
              {{ getActualBiomePercentage('saltwater').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('saltwater').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('saltwater')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('saltwater') - ((getTargetBiomePercentage('saltwater')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('saltwater') - ((getTargetBiomePercentage('saltwater')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('saltwater') - ((getTargetBiomePercentage('saltwater')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
                {{ getQuotaStatus('saltwater') }}
              </span>
              <br>
              ({{ getActualBiomeCount('saltwater').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #4080ff; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Freshwater (Lakes/Rivers)</strong><br>
              {{ getActualBiomePercentage('freshwater').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('freshwater').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('freshwater')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('freshwater') - ((getTargetBiomePercentage('freshwater')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('freshwater') - ((getTargetBiomePercentage('freshwater')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('freshwater') - ((getTargetBiomePercentage('freshwater')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('freshwater').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Forest Biomes -->
      <div style="margin-bottom: 15px;">
        <h5 style="margin-bottom: 10px; color: #228B22; border-bottom: 2px solid #228B22; padding-bottom: 5px;">üå≤ Forest Ecosystems</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #0d4f0d; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Boreal Forest</strong><br>
              {{ getActualBiomePercentage('borealForest').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('borealForest').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('borealForest')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('borealForest') - ((getTargetBiomePercentage('borealForest')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('borealForest') - ((getTargetBiomePercentage('borealForest')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('borealForest') - ((getTargetBiomePercentage('borealForest')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
                {{ getQuotaStatus('borealForest') }}
              </span>
              <br>
              ({{ getActualBiomeCount('borealForest').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #228B22; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Temperate Forest</strong><br>
              {{ getActualBiomePercentage('temperateForest').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('temperateForest').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('temperateForest')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('temperateForest') - ((getTargetBiomePercentage('temperateForest')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('temperateForest') - ((getTargetBiomePercentage('temperateForest')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('temperateForest') - ((getTargetBiomePercentage('temperateForest')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('temperateForest').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #32CD32; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Tropical Rainforest</strong><br>
              {{ getActualBiomePercentage('tropicalRainforest').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('tropicalRainforest').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('tropicalRainforest')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('tropicalRainforest') - ((getTargetBiomePercentage('tropicalRainforest')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('tropicalRainforest') - ((getTargetBiomePercentage('tropicalRainforest')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('tropicalRainforest') - ((getTargetBiomePercentage('tropicalRainforest')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('tropicalRainforest').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Grassland Biomes -->
      <div style="margin-bottom: 15px;">
        <h5 style="margin-bottom: 10px; color: #90EE90; border-bottom: 2px solid #90EE90; padding-bottom: 5px;">üåæ Grasslands & Savannas</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #90EE90; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Temperate Grassland</strong><br>
              {{ getActualBiomePercentage('temperateGrassland').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('temperateGrassland').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('temperateGrassland')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('temperateGrassland') - ((getTargetBiomePercentage('temperateGrassland')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('temperateGrassland') - ((getTargetBiomePercentage('temperateGrassland')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('temperateGrassland') - ((getTargetBiomePercentage('temperateGrassland')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('temperateGrassland').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #D2B48C; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Savanna</strong><br>
              {{ getActualBiomePercentage('savanna').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('savanna').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('savanna')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('savanna') - ((getTargetBiomePercentage('savanna')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('savanna') - ((getTargetBiomePercentage('savanna')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('savanna') - ((getTargetBiomePercentage('savanna')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('savanna').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #9ACD32; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Scrub & Shrublands</strong><br>
              {{ getActualBiomePercentage('scrub').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('scrub').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('scrub')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('scrub') - ((getTargetBiomePercentage('scrub')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('scrub') - ((getTargetBiomePercentage('scrub')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('scrub') - ((getTargetBiomePercentage('scrub')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('scrub').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Extreme Biomes -->
      <div style="margin-bottom: 15px;">
        <h5 style="margin-bottom: 10px; color: #D2691E; border-bottom: 2px solid #D2691E; padding-bottom: 5px;">üèîÔ∏è Extreme Environments</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #D2691E; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Deserts</strong><br>
              {{ getActualBiomePercentage('deserts').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('deserts').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('deserts')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('deserts') - ((getTargetBiomePercentage('deserts')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('deserts') - ((getTargetBiomePercentage('deserts')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('deserts') - ((getTargetBiomePercentage('deserts')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
                {{ getQuotaStatus('deserts') }}
              </span>
              <br>
              ({{ getActualBiomeCount('deserts').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #A9A9A9; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Tundra</strong><br>
              {{ getActualBiomePercentage('tundra').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('tundra').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('tundra')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('tundra') - ((getTargetBiomePercentage('tundra')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('tundra') - ((getTargetBiomePercentage('tundra')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('tundra') - ((getTargetBiomePercentage('tundra')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('tundra').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #696969; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Mountains</strong><br>
              {{ getActualBiomePercentage('mountains').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('mountains').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('mountains')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('mountains') - ((getTargetBiomePercentage('mountains')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('mountains') - ((getTargetBiomePercentage('mountains')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('mountains') - ((getTargetBiomePercentage('mountains')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('mountains').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Human Use Areas -->
      <div style="margin-bottom: 10px;">
        <h5 style="margin-bottom: 10px; color: #8B4513; border-bottom: 2px solid #8B4513; padding-bottom: 5px;">üè° Human Use Areas</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #DAA520; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Cropland</strong><br>
              {{ getActualBiomePercentage('cropland').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('cropland').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('cropland')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('cropland') - ((getTargetBiomePercentage('cropland')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('cropland') - ((getTargetBiomePercentage('cropland')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('cropland') - ((getTargetBiomePercentage('cropland')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('cropland').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #6B8E23; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Pastureland</strong><br>
              {{ getActualBiomePercentage('pastureland').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('pastureland').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('pastureland')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('pastureland') - ((getTargetBiomePercentage('pastureland')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('pastureland') - ((getTargetBiomePercentage('pastureland')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('pastureland') - ((getTargetBiomePercentage('pastureland')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('pastureland').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #2F4F4F; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Urban Areas</strong><br>
              {{ getActualBiomePercentage('urban').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('urban').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('urban')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('urban') - ((getTargetBiomePercentage('urban')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('urban') - ((getTargetBiomePercentage('urban')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('urban') - ((getTargetBiomePercentage('urban')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('urban').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Summary Stats -->
      <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 12px;">
          <div><strong>Total Water:</strong><br>
            {{ (getActualBiomePercentage('saltwater') + getActualBiomePercentage('freshwater')).toFixed(1) }}%<br>
            ({{ (getActualBiomeCount('saltwater') + getActualBiomeCount('freshwater')).toLocaleString() }} tiles)
          </div>
          <div><strong>Total Land:</strong><br>
            {{ (100 - (getActualBiomePercentage('saltwater') + getActualBiomePercentage('freshwater'))).toFixed(1) }}%<br>
            ({{ (populationBasedMapSize * populationBasedMapSize - getActualBiomeCount('saltwater') - getActualBiomeCount('freshwater')).toLocaleString() }} tiles)
          </div>
          <div><strong>Agricultural Land:</strong><br>
            {{ (getActualBiomePercentage('cropland') + getActualBiomePercentage('pastureland')).toFixed(1) }}%<br>
            ({{ (getActualBiomeCount('cropland') + getActualBiomeCount('pastureland')).toLocaleString() }} tiles)
          </div>
          <div><strong>Natural Areas:</strong><br>
            {{ (100 - (getActualBiomePercentage('saltwater') + getActualBiomePercentage('freshwater') + getActualBiomePercentage('cropland') + getActualBiomePercentage('pastureland') + getActualBiomePercentage('urban'))).toFixed(1) }}%<br>
            ({{ (populationBasedMapSize * populationBasedMapSize - getActualBiomeCount('saltwater') - getActualBiomeCount('freshwater') - getActualBiomeCount('cropland') - getActualBiomeCount('pastureland') - getActualBiomeCount('urban')).toLocaleString() }} tiles)
          </div>
        </div>
        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
          <strong>Map Scale:</strong> {{ populationBasedMapSize }}√ó{{ populationBasedMapSize }} = {{ (populationBasedMapSize * populationBasedMapSize).toLocaleString() }} total tiles (1 tile = 1 m¬≤)
        </div>
      </div>
        </div>
      </div>
    </div>

    <!-- Person Controls -->
    <div class="collapsible-section">
      <div class="collapsible-header" [class.collapsed]="sectionsCollapsed.person" (click)="toggleSection('person')">
        <span>üë§ Person Model (1:1 Scale)</span>
        <span class="collapsible-icon" [class.collapsed]="sectionsCollapsed.person">‚ñº</span>
      </div>
      <div class="collapsible-content" [class.collapsed]="sectionsCollapsed.person">
        <div class="section-body">
        <!-- Show/Hide Person -->
        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" [(ngModel)]="showPerson" (change)="togglePerson()" style="margin-right: 8px;" />
            <span style="font-weight: 600; color: #e65100;">Show Person on Map</span>
          </label>
        </div>

        <!-- Person Height -->
        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd;">
          <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 8px;">
            Height: {{ personHeight.toFixed(2) }}m
          </label>
          <input 
            type="range" 
            min="1.4" 
            max="2.1" 
            step="0.01" 
            [(ngModel)]="personHeight" 
            (input)="updatePerson()"
            style="width: 100%;" 
          />
          <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 4px;">
            <span>1.4m (4'7")</span>
            <span>2.1m (6'11")</span>
          </div>
        </div>

        <!-- Person Gender -->
        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd;">
          <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 8px;">
            Gender (affects colors):
          </label>
          <div style="display: flex; gap: 12px;">
            <label style="flex: 1; cursor: pointer;">
              <input 
                type="radio" 
                name="gender" 
                value="male" 
                [(ngModel)]="personGender" 
                (change)="updatePerson()"
                style="margin-right: 6px;"
              />
              Male
            </label>
            <label style="flex: 1; cursor: pointer;">
              <input 
                type="radio" 
                name="gender" 
                value="female" 
                [(ngModel)]="personGender" 
                (change)="updatePerson()"
                style="margin-right: 6px;"
              />
              Female
            </label>
          </div>
        </div>

        <!-- Person Info -->
        <div style="background: #fff; padding: 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; color: #666;">
          <strong style="color: #e65100;">Scale Reference:</strong><br>
          The person model is rendered at true 1:1 scale on the map.<br>
          Each tile = 1m¬≤, so you can compare the person's size to their allocated land area.<br><br>
          <strong>Person occupies:</strong> ~0.25m¬≤ (standing footprint)<br>
          <strong>Your land share:</strong> {{ squareMetersPerPerson.toLocaleString() }}m¬≤
        </div>

        <!-- Movement Controls -->
        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd; margin-top: 12px;">
          <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 8px;">
            üéÆ Walk & Jump Around the Map:
          </label>
          <div style="font-size: 12px; color: #666; line-height: 1.6;">
            <strong>Keyboard Controls:</strong><br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">W</kbd> or <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">‚Üë</kbd> - Move North<br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">S</kbd> or <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">‚Üì</kbd> - Move South<br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">A</kbd> or <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">‚Üê</kbd> - Move West<br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">D</kbd> or <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">‚Üí</kbd> - Move East<br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">Space</kbd> - Jump! ü¶ò
          </div>
          <div style="margin-top: 10px;">
            <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 8px;">
              Movement Speed: {{ personSpeed.toFixed(2) }}m/frame
            </label>
            <input 
              type="range" 
              min="0.05" 
              max="1.0" 
              step="0.05" 
              [(ngModel)]="personSpeed" 
              style="width: 100%;" 
            />
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 4px;">
              <span>Slow (0.05)</span>
              <span>Fast (1.0)</span>
            </div>
          </div>
          <div style="margin-top: 8px; font-size: 11px; color: #999;">
            Current Position: ({{ personPosition.x.toFixed(1) }}, {{ personPosition.z.toFixed(1) }})
          </div>
        </div>
        </div>
      </div>
    </div>

  </div>
</div>
