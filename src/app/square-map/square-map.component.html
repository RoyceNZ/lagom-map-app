<div class="square-map-container">
  <div #rendererContainer id="rendererContainer"></div>
  
  <!-- Hover Tooltip -->
  <div class="hover-tooltip" *ngIf="hoveredTileInfo">
    <div class="tooltip-biome">{{ hoveredTileInfo.biome }}</div>
    <div class="tooltip-coords">Position: ({{ hoveredTileInfo.x }}, {{ hoveredTileInfo.z }})</div>
  </div>
  
  <div class="filters">
    
        <!-- Terrain Generation Controls -->
    <div class="terrain-controls" style="margin-bottom: 20px; padding: 15px; background: #f1f8ff; border-radius: 8px; border: 2px solid #b3d9ff;">
      <h4 style="margin-top: 0; margin-bottom: 15px; color: #2c5aa0; text-align: center;">üó∫Ô∏è Natural Terrain Generation</h4>
      
        <div style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Earth Quota (always enforced) -->
        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd;">
          <div style="font-weight: 600; color: #2c5aa0;">üåç Enforce Earth-Based Biome Percentages (always on)</div>
          <div style="font-size: 12px; color: #666; margin-top: 4px;">
            The map enforces exact Earth percentages and applies clustering to preserve natural appearance.
          </div>
        </div>

       
    </div>
    
  
    <!-- Population-Based Map Sizing -->
    <div class="population-controls">
      <h4>Population-Based Map Sizing</h4>
      <label>
        <input type="checkbox" [(ngModel)]="usePopulationSizing" (change)="updateMap()" />
        Use Population-Based Map Size
      </label>
      <label>
        Year:
        <input type="number" min="1800" max="2050" [(ngModel)]="selectedYear" (input)="updateMap()" />
      </label>
      <div class="population-info" *ngIf="usePopulationSizing">
        <small>
          <strong>Population in {{ selectedYear }}: {{ getWorldPopulation(selectedYear).toLocaleString() }}</strong><br><br>
          
          <strong>Total Earth Surface Per Person:</strong><br>
          ‚Ä¢ Total area (inc. oceans): {{ totalAreaPerPerson.toLocaleString() }} m¬≤<br>
          ‚Ä¢ Ocean area: {{ oceanAreaPerPerson.toLocaleString() }} m¬≤ (70.9%)<br>
          ‚Ä¢ Total land area: {{ squareMetersPerPerson.toLocaleString() }} m¬≤ (29.1%)<br><br>
          
          <strong>Biome Breakdown Per Person:</strong><br>
          ‚Ä¢ Saltwater (oceans/seas): {{ landBreakdownPerPerson['saltwater'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Freshwater (lakes/rivers): {{ landBreakdownPerPerson['freshwater'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Boreal Forest: {{ landBreakdownPerPerson['borealForest'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Temperate Forest: {{ landBreakdownPerPerson['temperateForest'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Tropical Rainforest: {{ landBreakdownPerPerson['tropicalRainforest'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Temperate Grassland: {{ landBreakdownPerPerson['temperateGrassland'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Savanna: {{ landBreakdownPerPerson['savanna'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Tundra: {{ landBreakdownPerPerson['tundra'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Deserts: {{ landBreakdownPerPerson['deserts'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Mountains: {{ landBreakdownPerPerson['mountains'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Pastureland: {{ landBreakdownPerPerson['pastureland'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Cropland: {{ landBreakdownPerPerson['cropland'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Scrub: {{ landBreakdownPerPerson['scrub'].toLocaleString() }} m¬≤<br>
          ‚Ä¢ Urban Areas: {{ landBreakdownPerPerson['urban'].toLocaleString() }} m¬≤<br><br>
          
          <strong style="color: #ff6b35;">Actually usable for living: {{ usableAreaPerPerson.toLocaleString() }} m¬≤ (~11% of land)</strong><br><br>
          
          <strong>Natural Island Terrain Layout:</strong><br>
          ‚Ä¢ <span style="color: #4682B4;">Ocean & Lakes</span> ‚Üí Blue water terrain (outer ocean + inland lakes/rivers)<br>
          ‚Ä¢ <span style="color: #D2691E;">Coastal Deserts</span> ‚Üí Sandy beaches and arid coastal zones<br>
          ‚Ä¢ <span style="color: #228B22;">Temperate Forests</span> ‚Üí Dense green forest zones<br>
          ‚Ä¢ <span style="color: #90EE90;">Grasslands & Pastures</span> ‚Üí Green meadows and agricultural valleys<br>
          ‚Ä¢ <span style="color: #696969;">Mountains & Peaks</span> ‚Üí Rocky highland terrain<br>
          ‚Ä¢ <span style="color: #8B4513;">Cropland & Valleys</span> ‚Üí Brown agricultural and valley terrain<br>
          ‚Ä¢ <span style="color: #2F4F4F;">Urban Centers</span> ‚Üí Stone urban development<br><br>
          
          <strong>Map Visualization:</strong><br>
          ‚Ä¢ Each tile: 1m √ó 1m<br>
          ‚Ä¢ Map size: {{ populationBasedMapSize }}√ó{{ populationBasedMapSize }} tiles<br>
          ‚Ä¢ Represents: {{ (populationBasedMapSize * populationBasedMapSize).toLocaleString() }} m¬≤ (1:1 scale)<br>
          ‚Ä¢ Total Earth surface per person: {{ totalAreaPerPerson.toLocaleString() }} m¬≤ (includes oceans, land, everything)<br>
          ‚Ä¢ Scale: **TRUE 1:1 SCALE** - Each map square meter = 1 real square meter of your Earth share!
        </small>
      </div>
    </div>
    
      
    </div>
    <!-- Map Legend -->
    <div class="map-legend" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
      <h4 style="margin-top: 0; margin-bottom: 15px; color: #495057; text-align: center;">üó∫Ô∏è Biome & Terrain Legend</h4>
      
      <!-- Water Biomes -->
      <div style="margin-bottom: 15px;">
        <h5 style="margin-bottom: 10px; color: #0066cc; border-bottom: 2px solid #0066cc; padding-bottom: 5px;">üíß Water Bodies</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #20a0ff; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Saltwater (Oceans/Seas)</strong><br>
              {{ getActualBiomePercentage('saltwater').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('saltwater').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('saltwater')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('saltwater') - ((getTargetBiomePercentage('saltwater')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('saltwater') - ((getTargetBiomePercentage('saltwater')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('saltwater') - ((getTargetBiomePercentage('saltwater')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
                {{ getQuotaStatus('saltwater') }}
              </span>
              <br>
              ({{ getActualBiomeCount('saltwater').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #4080ff; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Freshwater (Lakes/Rivers)</strong><br>
              {{ getActualBiomePercentage('freshwater').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('freshwater').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('freshwater')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('freshwater') - ((getTargetBiomePercentage('freshwater')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('freshwater') - ((getTargetBiomePercentage('freshwater')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('freshwater') - ((getTargetBiomePercentage('freshwater')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('freshwater').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Forest Biomes -->
      <div style="margin-bottom: 15px;">
        <h5 style="margin-bottom: 10px; color: #228B22; border-bottom: 2px solid #228B22; padding-bottom: 5px;">üå≤ Forest Ecosystems</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #0d4f0d; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Boreal Forest</strong><br>
              {{ getActualBiomePercentage('borealForest').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('borealForest').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('borealForest')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('borealForest') - ((getTargetBiomePercentage('borealForest')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('borealForest') - ((getTargetBiomePercentage('borealForest')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('borealForest') - ((getTargetBiomePercentage('borealForest')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
                {{ getQuotaStatus('borealForest') }}
              </span>
              <br>
              ({{ getActualBiomeCount('borealForest').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #228B22; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Temperate Forest</strong><br>
              {{ getActualBiomePercentage('temperateForest').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('temperateForest').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('temperateForest')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('temperateForest') - ((getTargetBiomePercentage('temperateForest')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('temperateForest') - ((getTargetBiomePercentage('temperateForest')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('temperateForest') - ((getTargetBiomePercentage('temperateForest')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('temperateForest').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #32CD32; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Tropical Rainforest</strong><br>
              {{ getActualBiomePercentage('tropicalRainforest').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('tropicalRainforest').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('tropicalRainforest')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('tropicalRainforest') - ((getTargetBiomePercentage('tropicalRainforest')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('tropicalRainforest') - ((getTargetBiomePercentage('tropicalRainforest')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('tropicalRainforest') - ((getTargetBiomePercentage('tropicalRainforest')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('tropicalRainforest').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Grassland Biomes -->
      <div style="margin-bottom: 15px;">
        <h5 style="margin-bottom: 10px; color: #90EE90; border-bottom: 2px solid #90EE90; padding-bottom: 5px;">üåæ Grasslands & Savannas</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #90EE90; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Temperate Grassland</strong><br>
              {{ getActualBiomePercentage('temperateGrassland').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('temperateGrassland').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('temperateGrassland')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('temperateGrassland') - ((getTargetBiomePercentage('temperateGrassland')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('temperateGrassland') - ((getTargetBiomePercentage('temperateGrassland')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('temperateGrassland') - ((getTargetBiomePercentage('temperateGrassland')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('temperateGrassland').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #D2B48C; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Savanna</strong><br>
              {{ getActualBiomePercentage('savanna').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('savanna').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('savanna')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('savanna') - ((getTargetBiomePercentage('savanna')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('savanna') - ((getTargetBiomePercentage('savanna')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('savanna') - ((getTargetBiomePercentage('savanna')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('savanna').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #9ACD32; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Scrub & Shrublands</strong><br>
              {{ getActualBiomePercentage('scrub').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('scrub').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('scrub')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('scrub') - ((getTargetBiomePercentage('scrub')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('scrub') - ((getTargetBiomePercentage('scrub')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('scrub') - ((getTargetBiomePercentage('scrub')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('scrub').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Extreme Biomes -->
      <div style="margin-bottom: 15px;">
        <h5 style="margin-bottom: 10px; color: #D2691E; border-bottom: 2px solid #D2691E; padding-bottom: 5px;">üèîÔ∏è Extreme Environments</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #D2691E; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Deserts</strong><br>
              {{ getActualBiomePercentage('deserts').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('deserts').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('deserts')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('deserts') - ((getTargetBiomePercentage('deserts')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('deserts') - ((getTargetBiomePercentage('deserts')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('deserts') - ((getTargetBiomePercentage('deserts')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
                {{ getQuotaStatus('deserts') }}
              </span>
              <br>
              ({{ getActualBiomeCount('deserts').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #A9A9A9; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Tundra</strong><br>
              {{ getActualBiomePercentage('tundra').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('tundra').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('tundra')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('tundra') - ((getTargetBiomePercentage('tundra')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('tundra') - ((getTargetBiomePercentage('tundra')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('tundra') - ((getTargetBiomePercentage('tundra')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('tundra').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #696969; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Mountains</strong><br>
              {{ getActualBiomePercentage('mountains').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('mountains').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('mountains')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('mountains') - ((getTargetBiomePercentage('mountains')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('mountains') - ((getTargetBiomePercentage('mountains')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('mountains') - ((getTargetBiomePercentage('mountains')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('mountains').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Human Use Areas -->
      <div style="margin-bottom: 10px;">
        <h5 style="margin-bottom: 10px; color: #8B4513; border-bottom: 2px solid #8B4513; padding-bottom: 5px;">üè° Human Use Areas</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #DAA520; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Cropland</strong><br>
              {{ getActualBiomePercentage('cropland').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('cropland').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('cropland')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('cropland') - ((getTargetBiomePercentage('cropland')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('cropland') - ((getTargetBiomePercentage('cropland')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('cropland') - ((getTargetBiomePercentage('cropland')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('cropland').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #6B8E23; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Pastureland</strong><br>
              {{ getActualBiomePercentage('pastureland').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('pastureland').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('pastureland')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('pastureland') - ((getTargetBiomePercentage('pastureland')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('pastureland') - ((getTargetBiomePercentage('pastureland')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('pastureland') - ((getTargetBiomePercentage('pastureland')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('pastureland').toLocaleString() }} tiles)</span>
          </div>
          <div style="display: flex; align-items: center; padding: 4px;">
            <div style="width: 20px; height: 20px; background: #2F4F4F; border: 1px solid #ccc; margin-right: 8px; border-radius: 3px;"></div>
            <span style="font-size: 13px;"><strong>Urban Areas</strong><br>
              {{ getActualBiomePercentage('urban').toFixed(1) }}% 
              <span style="color: #666; display:block;">
                (Target: {{ getTargetBiomePercentage('urban').toFixed(1) }}% ‚Äî {{ ((getTargetBiomePercentage('urban')/100) * (populationBasedMapSize * populationBasedMapSize)) | number:'1.0-0' }} tiles)
                <br>
                <span [style.color]="(getActualBiomeCount('urban') - ((getTargetBiomePercentage('urban')/100) * (populationBasedMapSize*populationBasedMapSize))) === 0 ? '#666' : (getActualBiomeCount('urban') - ((getTargetBiomePercentage('urban')/100) * (populationBasedMapSize*populationBasedMapSize)) ) > 0 ? 'red' : 'green'">
                  Œî: {{ (getActualBiomeCount('urban') - ((getTargetBiomePercentage('urban')/100) * (populationBasedMapSize*populationBasedMapSize))) | number:'1.0-0' }} tiles
                </span>
              </span>
              <br>
              ({{ getActualBiomeCount('urban').toLocaleString() }} tiles)</span>
          </div>
        </div>
      </div>

      <!-- Summary Stats -->
      <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 12px;">
          <div><strong>Total Water:</strong><br>
            {{ (getActualBiomePercentage('saltwater') + getActualBiomePercentage('freshwater')).toFixed(1) }}%<br>
            ({{ (getActualBiomeCount('saltwater') + getActualBiomeCount('freshwater')).toLocaleString() }} tiles)
          </div>
          <div><strong>Total Land:</strong><br>
            {{ (100 - (getActualBiomePercentage('saltwater') + getActualBiomePercentage('freshwater'))).toFixed(1) }}%<br>
            ({{ (populationBasedMapSize * populationBasedMapSize - getActualBiomeCount('saltwater') - getActualBiomeCount('freshwater')).toLocaleString() }} tiles)
          </div>
          <div><strong>Agricultural Land:</strong><br>
            {{ (getActualBiomePercentage('cropland') + getActualBiomePercentage('pastureland')).toFixed(1) }}%<br>
            ({{ (getActualBiomeCount('cropland') + getActualBiomeCount('pastureland')).toLocaleString() }} tiles)
          </div>
          <div><strong>Natural Areas:</strong><br>
            {{ (100 - (getActualBiomePercentage('saltwater') + getActualBiomePercentage('freshwater') + getActualBiomePercentage('cropland') + getActualBiomePercentage('pastureland') + getActualBiomePercentage('urban'))).toFixed(1) }}%<br>
            ({{ (populationBasedMapSize * populationBasedMapSize - getActualBiomeCount('saltwater') - getActualBiomeCount('freshwater') - getActualBiomeCount('cropland') - getActualBiomeCount('pastureland') - getActualBiomeCount('urban')).toLocaleString() }} tiles)
          </div>
        </div>
        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; font-size: 11px; color: #666;">
          <strong>Map Scale:</strong> {{ populationBasedMapSize }}√ó{{ populationBasedMapSize }} = {{ (populationBasedMapSize * populationBasedMapSize).toLocaleString() }} total tiles (1 tile = 1 m¬≤)
        </div>
      </div>
    </div>

    <!-- Person Controls -->
    <div class="person-controls" style="margin-bottom: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 2px solid #ffb74d;">
      <h4 style="margin-top: 0; margin-bottom: 15px; color: #e65100; text-align: center;">üë§ Person Model (1:1 Scale)</h4>
      
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Show/Hide Person -->
        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" [(ngModel)]="showPerson" (change)="togglePerson()" style="margin-right: 8px;" />
            <span style="font-weight: 600; color: #e65100;">Show Person on Map</span>
          </label>
        </div>

        <!-- Person Height -->
        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd;">
          <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 8px;">
            Height: {{ personHeight.toFixed(2) }}m
          </label>
          <input 
            type="range" 
            min="1.4" 
            max="2.1" 
            step="0.01" 
            [(ngModel)]="personHeight" 
            (input)="updatePerson()"
            style="width: 100%;" 
          />
          <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 4px;">
            <span>1.4m (4'7")</span>
            <span>2.1m (6'11")</span>
          </div>
        </div>

        <!-- Person Gender -->
        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd;">
          <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 8px;">
            Gender (affects colors):
          </label>
          <div style="display: flex; gap: 12px;">
            <label style="flex: 1; cursor: pointer;">
              <input 
                type="radio" 
                name="gender" 
                value="male" 
                [(ngModel)]="personGender" 
                (change)="updatePerson()"
                style="margin-right: 6px;"
              />
              Male
            </label>
            <label style="flex: 1; cursor: pointer;">
              <input 
                type="radio" 
                name="gender" 
                value="female" 
                [(ngModel)]="personGender" 
                (change)="updatePerson()"
                style="margin-right: 6px;"
              />
              Female
            </label>
          </div>
        </div>

        <!-- Person Info -->
        <div style="background: #fff; padding: 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; color: #666;">
          <strong style="color: #e65100;">Scale Reference:</strong><br>
          The person model is rendered at true 1:1 scale on the map.<br>
          Each tile = 1m¬≤, so you can compare the person's size to their allocated land area.<br><br>
          <strong>Person occupies:</strong> ~0.25m¬≤ (standing footprint)<br>
          <strong>Your land share:</strong> {{ squareMetersPerPerson.toLocaleString() }}m¬≤
        </div>

        <!-- Movement Controls -->
        <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd; margin-top: 12px;">
          <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 8px;">
            üéÆ Walk & Jump Around the Map:
          </label>
          <div style="font-size: 12px; color: #666; line-height: 1.6;">
            <strong>Keyboard Controls:</strong><br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">W</kbd> or <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">‚Üë</kbd> - Move North<br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">S</kbd> or <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">‚Üì</kbd> - Move South<br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">A</kbd> or <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">‚Üê</kbd> - Move West<br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">D</kbd> or <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">‚Üí</kbd> - Move East<br>
            ‚Ä¢ <kbd style="background: #f0f0f0; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px;">Space</kbd> - Jump! ü¶ò
          </div>
          <div style="margin-top: 10px;">
            <label style="font-weight: 600; color: #e65100; display: block; margin-bottom: 8px;">
              Movement Speed: {{ personSpeed.toFixed(2) }}m/frame
            </label>
            <input 
              type="range" 
              min="0.05" 
              max="1.0" 
              step="0.05" 
              [(ngModel)]="personSpeed" 
              style="width: 100%;" 
            />
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #666; margin-top: 4px;">
              <span>Slow (0.05)</span>
              <span>Fast (1.0)</span>
            </div>
          </div>
          <div style="margin-top: 8px; font-size: 11px; color: #999;">
            Current Position: ({{ personPosition.x.toFixed(1) }}, {{ personPosition.z.toFixed(1) }})
          </div>
        </div>
      </div>
    </div>

  </div>
